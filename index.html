<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tsuchiura Sound Archive</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html,body{height:100%;margin:0;background:#000;color:#e8e0c9;}
  #map{width:100vw;height:100vh;}
  .leaflet-container{background:#000;}
  .hud{
    position:fixed;right:12px;top:12px;z-index:600;
    background:#111a;color:#ffd86b;border:1px solid #ffd86b55;
    font:12px/1.4 system-ui;padding:8px 10px;border-radius:10px;backdrop-filter:blur(4px);
  }
  .hud .row{margin-top:6px}
  .hud button{margin-top:6px;border:1px solid #ffd86b55;border-radius:8px;
    background:#222;color:#ffd86b;padding:6px 10px;cursor:pointer}
  .popup{width:min(360px,86vw);font:14px/1.6 system-ui,"Noto Sans JP",sans-serif;color:#111;}
  .popup img{width:100%;height:auto;border-radius:10px;margin-bottom:8px;}
  .popup .meta{font-size:12px;color:#555;margin:6px 0;}
  .popup audio{width:100%;margin-top:6px;}
  .popup .alt{margin-top:8px;font-size:12px;}
  .popup .alt a{color:#0a58ff;}
</style>
</head>
<body>
<div id="map"></div>

<div class="hud">
  <div>img: <span id="sz">â€”</span></div>
  <div class="row">x:<span id="px">â€”</span> / y:<span id="py">â€”</span></div>
  <button id="copyBtn">ğŸ“‹ JSONã‚³ãƒ”ãƒ¼ï¼ˆæœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã—ãŸåº§æ¨™ï¼‰</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(async () => {
  const IMG_URL = './tsuchiura_map.jpg';
  const DATA_URL = './spots.json'; // â† ã“ã“ã‹ã‚‰ãƒ”ãƒ³ã‚’èª­ã‚€
  const BASE = new URL('.', location.href).href;
  const abs  = rel => new URL(rel, BASE).href;
  const Z0 = 0; // ã€Œç”»åƒãƒ”ã‚¯ã‚»ãƒ«ã€å˜ä½ã«ãã‚ãˆã‚‹ãŸã‚ zoom=0 ã‚’æ¡ç”¨

  // ç”»åƒã‚µã‚¤ã‚ºå–å¾—
  const img = await new Promise((resolve, reject)=>{
    const i = new Image();
    i.onload = () => resolve(i);
    i.onerror = reject;
    i.src = IMG_URL;
  });
  const W = img.naturalWidth, H = img.naturalHeight; // ä¾‹: 1024Ã—1536
  document.getElementById('sz').textContent = `${W}Ã—${H}px`;

  // ãƒãƒƒãƒ—åˆæœŸåŒ–ï¼ˆCRS.Simpleï¼‰
  const bounds = [[0,0],[H,W]];
  const map = L.map('map',{ crs:L.CRS.Simple, minZoom:-4, maxZoom:4, zoomControl:true });
  L.imageOverlay(IMG_URL, bounds).addTo(map);
  map.fitBounds(bounds, { padding:[0,0] });
  map.setMaxBounds(bounds);

  // å¤‰æ›ï¼ˆYã¯ä¸Šä¸‹åè»¢ã«æ³¨æ„ï¼‰
  const toLatLng = (x,y) => map.unproject([x, H - y], Z0);
  const toPixel  = (ll)    => {
    const p = map.project(ll, Z0);
    return { x: Math.round(p.x), y: Math.round(H - p.y) };
  };

  // spots.json ã‚’å–å¾—
  let spots = [];
  try {
    const res = await fetch(DATA_URL, { cache:'no-store' });
    spots = await res.json();
  } catch(e) {
    console.warn('spots.json ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ç©ºé…åˆ—ã§ç¶šè¡Œã—ã¾ã™ã€‚', e);
    spots = [];
  }

  // ãƒ”ãƒ³æç”»
  const icon = L.icon({
    iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
    shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
  });

  spots.forEach(s=>{
    // audio ã¯é…åˆ—ã§ [mp3,wav] ãªã©ã®é †ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const audioSources = (s.audio || []).map(src=>{
      const type = src.endsWith('.mp3') ? 'audio/mpeg'
                 : src.endsWith('.wav') ? 'audio/wav'
                 : '';
      return type ? `<source src="${src}" type="${type}">` : '';
    }).join('');

    const html = `
      <div class="popup">
        ${s.photo ? `<img src="${s.photo}" alt="${s.title||''}">` : ``}
        <div class="meta">${s.title||''} ${s.recorder?`ï½œ REC: ${s.recorder}`:''} ${s.date?`ï½œ ${s.date}`:''}</div>
        <div>${s.desc||''}</div>
        ${audioSources ? `
          <audio controls preload="metadata" playsinline>${audioSources}
            ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
          </audio>
          <div class="alt">å†ç”Ÿã§ããªã„ã¨ãã¯ <a href="${s.audio?.[0]||s.audio?.[1]||'#'}" target="_blank" rel="noopener">éŸ³æºã‚’ç›´æ¥é–‹ã</a></div>
        ` : ``}
      </div>`;

    L.marker(toLatLng(s.x, s.y),{icon}).addTo(map).bindPopup(html);
  });

  // ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™è¡¨ç¤ºï¼‹JSONãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
  let lastXY = {x:null, y:null};
  map.on('click', e=>{
    lastXY = toPixel(e.latlng);
    document.getElementById('px').textContent = lastXY.x;
    document.getElementById('py').textContent = lastXY.y;
  });

  document.getElementById('copyBtn').onclick = async ()=>{
    if(lastXY.x==null){ alert('ã¾ãšåœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åº§æ¨™ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚'); return; }
    const template = {
      "title": "ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›",
      "x": lastXY.x,
      "y": lastXY.y,
      "recorder": "ãŠåå‰",
      "date": "2025-10-12",
      "photo": "img/your_photo.jpg",
      "audio": ["audio/your_audio.mp3", "audio/your_audio.wav"],
      "desc": "ãƒ¡ãƒ¢"
    };
    try{
      await navigator.clipboard.writeText(JSON.stringify(template, null, 2));
      alert('JSONãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚spots.json ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
    }catch(_){
      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ä¸å¯ã®ç’°å¢ƒå‘ã‘ã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
      prompt('ä¸‹ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ spots.json ã«è¿½è¨˜ã—ã¦ãã ã•ã„ï¼š', JSON.stringify(template, null, 2));
    }
  };
})();
</script>
</body>
</html>
