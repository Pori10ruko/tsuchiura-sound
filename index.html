<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tsuchiura Sound Archive</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html,body{height:100%;margin:0;background:#000;color:#e8e0c9;}
  #map{width:100vw;height:100vh;}
  .leaflet-container{background:#000;}
  
  /* å³ä¸Šã®åº§æ¨™è¡¨ç¤ºï¼†ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ */
  .hud{
    position:fixed;right:12px;top:12px;z-index:600;
    background:#111a;color:#ffd86b;border:1px solid #ffd86b55;
    font:12px/1.4 system-ui;padding:8px 10px;border-radius:10px;backdrop-filter:blur(4px);
    max-width: 200px;
  }
  .hud button{
    margin-top:6px;width:100%;border:1px solid #ffd86b55;border-radius:4px;
    background:#333;color:#ffd86b;padding:4px;cursor:pointer;
  }

  /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
  .popup{width:min(320px,80vw);font:14px/1.6 system-ui,"Noto Sans JP",sans-serif;color:#111;}
  .popup img{width:100%;height:auto;border-radius:6px;margin-bottom:8px;object-fit:cover;}
  .popup .meta{font-size:12px;color:#555;margin-bottom:4px;font-weight:bold;}
  .popup .desc{font-size:13px;margin-bottom:8px;}
  
  /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼éƒ¨åˆ† */
  .player-box {background:#f0f0f0; padding:8px; border-radius:6px;}
  .player-box audio {width:100%; margin-bottom:8px;}
  .track-list {max-height:150px; overflow-y:auto; border-top:1px solid #ccc;}
  .track-btn {
    display:block; width:100%; text-align:left; padding:6px; border:none; border-bottom:1px solid #ddd;
    background:#fff; cursor:pointer; font-size:13px;
  }
  .track-btn:hover {background:#eef;}
  .track-btn.playing {background:#ffd86b; color:#000; font-weight:bold;}
</style>
</head>
<body>

<div id="map"></div>

<div class="hud">
  <div>img: <span id="sz">loading...</span></div>
  <div>x:<span id="px">â€”</span> / y:<span id="py">â€”</span></div>
  <button id="copyBtn">ğŸ“‹ ãƒ”ãƒ³è¿½åŠ ç”¨ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
  <div style="font-size:10px;color:#ccc;margin-top:4px;">â€»åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‹ã‚‰æŠ¼ã™</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(async () => {
  // â–  è¨­å®šï¼šç”»åƒã¨ãƒ‡ãƒ¼ã‚¿
  const IMG_URL  = './tsuchiura_map.jpg'; // åœ°å›³ç”»åƒ
  const DATA_URL = './spots.json';        // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«
  
  // URLè£œæ­£ç”¨
  const BASE = new URL('.', location.href).href;
  const abs = rel => new URL(rel, BASE).href;

  // ç”»åƒã‚µã‚¤ã‚ºå–å¾—ã¨ãƒãƒƒãƒ—åˆæœŸåŒ–
  const img = await new Promise((res, rej)=>{
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = IMG_URL;
  });
  const W = img.naturalWidth, H = img.naturalHeight;
  document.getElementById('sz').textContent = `${W}Ã—${H}px`;

  // åº§æ¨™ç³»è¨­å®šï¼ˆå·¦ä¸ŠåŸç‚¹ã€Yè»¸åè»¢å¯¾å¿œï¼‰
  const bounds = [[0,0],[H,W]];
  const map = L.map('map',{ crs:L.CRS.Simple, minZoom:-4, maxZoom:4, zoomControl:true });
  L.imageOverlay(IMG_URL, bounds).addTo(map);
  map.fitBounds(bounds, { padding:[0,0] });
  map.setMaxBounds(bounds);

  const toLatLng = (x,y) => map.unproject([x, H - y], 0);
  const toPixel  = (ll)  => {
    const p = map.project(ll, 0);
    return { x: Math.round(p.x), y: Math.round(H - p.y) };
  };

  // spots.json èª­ã¿è¾¼ã¿
  let spots = [];
  try {
    const res = await fetch(DATA_URL, { cache:'no-store' });
    spots = await res.json();
  } catch(e) {
    console.warn('JSONèª­è¾¼ã‚¨ãƒ©ãƒ¼ï¼ˆåˆå›ã¯ç„¡è¦–ã—ã¦ãã ã•ã„ï¼‰', e);
  }

  // â–¼ ãƒ”ãƒ³ã‚’åœ°å›³ã«åˆºã™å‡¦ç†
  const icon = L.icon({
    iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
    shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
  });

  spots.forEach((spot, index) => {
    // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ç”Ÿæˆ
    const tracks = spot.playlist || [];
    // æœ€åˆã®æ›²ï¼ˆãªã‘ã‚Œã°ç©ºï¼‰
    const firstTrack = tracks[0] ? abs(tracks[0].file) : '';
    
    // HTMLçµ„ã¿ç«‹ã¦
    const div = document.createElement('div');
    div.className = 'popup';
    div.innerHTML = `
      ${spot.photo ? `<img src="${abs(spot.photo)}">` : ''}
      <div class="meta">${spot.title || 'No Title'}</div>
      <div class="desc">${spot.desc || ''}</div>
      <div class="player-box">
        <audio controls id="audio-${index}" src="${firstTrack}"></audio>
        <div class="track-list" id="list-${index}">
          </div>
      </div>
    `;

    // ãƒˆãƒ©ãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«è¿½åŠ 
    const listContainer = div.querySelector(`#list-${index}`);
    const audioEl = div.querySelector(`#audio-${index}`);

    tracks.forEach((track, i) => {
      const btn = document.createElement('button');
      btn.className = 'track-btn';
      btn.innerHTML = `â–¶ ${track.name}`;
      btn.onclick = () => {
        // æ›²ã‚’åˆ‡ã‚Šæ›¿ãˆ
        audioEl.src = abs(track.file);
        audioEl.play();
        // è‰²ã‚’å¤‰ãˆã‚‹
        div.querySelectorAll('.track-btn').forEach(b => b.classList.remove('playing'));
        btn.classList.add('playing');
      };
      listContainer.appendChild(btn);
    });

    L.marker(toLatLng(spot.x, spot.y), {icon}).addTo(map).bindPopup(div);
  });

  // â–¼ åº§æ¨™å–å¾—ã¨ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
  let lastXY = {x:null, y:null};
  map.on('click', e => {
    lastXY = toPixel(e.latlng);
    document.getElementById('px').textContent = lastXY.x;
    document.getElementById('py').textContent = lastXY.y;
  });

  document.getElementById('copyBtn').onclick = async () => {
    if(lastXY.x == null){ alert('åœ°å›³ä¸Šã®ãƒ”ãƒ³ã‚’ç½®ããŸã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„'); return; }
    
    // ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå¯¾å¿œç‰ˆï¼‰
    const template = {
      "title": "ã‚¨ãƒªã‚¢åã‚’å…¥åŠ›",
      "x": lastXY.x,
      "y": lastXY.y,
      "desc": "èª¬æ˜æ–‡",
      "photo": "gazou.jpg",
      "playlist": [
        { "name": "éŒ²éŸ³1ã®ã‚¿ã‚¤ãƒˆãƒ«", "file": "sound1.mp3" },
        { "name": "éŒ²éŸ³2ã®ã‚¿ã‚¤ãƒˆãƒ«", "file": "sound2.mp3" }
      ]
    };

    const text = JSON.stringify(template, null, 2) + ","; // å¾Œã‚ã«ã‚«ãƒ³ãƒã¤ã‘ã¦ãŠã
    try {
      await navigator.clipboard.writeText(text);
      alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nspots.json ã‚’é–‹ãã€[ ] ã®ä¸­ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
    } catch(e) {
      prompt('ã‚³ãƒ”ãƒ¼ã—ã¦ spots.json ã«è²¼ã£ã¦ãã ã•ã„:', text);
    }
  };

})();
</script>
</body>
</html>
