<script>
  const IMG_URL = './tsuchiura_map.jpg';
  const BASE = new URL('.', location.href).href;
  const abs = rel => new URL(rel, BASE).href;

  let spot = {
    title: 'テスト：川の音',
    x: 512,   // ← 横方向の中央
    y: 768,   // ← 縦方向の中央（これが上下反転されてた）
    recorder: 'Your Name',
    date: '2025-10-12',
    photo: abs('./sample.jpg'),
    audioWav: abs('./sample.wav?v=1'),
    audioMp3: abs('./sample.mp3?v=1'),
    description: '霞ヶ浦総合公園ちかくの川沿いで録音。'
  };

  // --- 以前の位置データを消去（初回限定） ---
  localStorage.removeItem('spotXY');

  const img = new Image();
  img.onload = () => {
    const W = img.naturalWidth, H = img.naturalHeight;
    sz.textContent = `${W}×${H}px`;

    const bounds = [[0,0],[H,W]];
    const map = L.map('map',{crs:L.CRS.Simple,minZoom:-4,maxZoom:4});
    L.imageOverlay(IMG_URL,bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    const toLatLng = (x,y)=> map.unproject([x, H - y], map.getMaxZoom()); 
    const toPixel  = (latlng)=> {
      const p = map.project(latlng, map.getMaxZoom());
      return {x:p.x, y:H - p.y};
    };

    let marker;
    const drawMarker = ()=>{
      const ll = toLatLng(spot.x, spot.y);
      if (marker) map.removeLayer(marker);
      const icon = L.icon({
        iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
        shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
        iconSize:[25,41], iconAnchor:[12,41]
      });
      const html = `
        <div class="popup">
          <img src="${spot.photo}" alt="">
          <div class="meta">${spot.title} ｜ REC: ${spot.recorder} ｜ ${spot.date}</div>
          <div>${spot.description}</div>
          <audio controls preload="metadata" playsinline>
            <source src="${spot.audioWav}" type="audio/wav">
            ${spot.audioMp3 ? `<source src="${spot.audioMp3}" type="audio/mpeg">` : ``}
          </audio>
        </div>`;
      marker = L.marker(ll,{icon}).addTo(map).bindPopup(html);
    };

    drawMarker();
    map.setView(toLatLng(spot.x, spot.y), 0, {animate:true});
    marker.openPopup();

    map.on('click', e=>{
      const p = toPixel(e.latlng);
      spot.x = Math.round(p.x);
      spot.y = Math.round(p.y);
      px.textContent = spot.x;
      py.textContent = spot.y;
      drawMarker();
    });
  };
  img.src = IMG_URL;
</script>
