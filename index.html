<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tsuchiura Sound Archive</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg:#000;
    --fg:#e8e0c9;
    --accent:#ffd86b;
    --accentBorder:rgba(255,216,107,.35);
    --panel:rgba(12,12,12,.92);
    --panel2:rgba(0,0,0,.35);
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);}
  #map{width:100vw;height:100vh;}
  .leaflet-container{background:var(--bg);}

  /* Leaflet popup theme (dark + gold) */
  .leaflet-popup-content-wrapper,
  .leaflet-popup-tip{
    background:var(--panel);
    color:var(--fg);
    border:1px solid var(--accentBorder);
    box-shadow:0 18px 45px rgba(0,0,0,.65);
  }
  .leaflet-popup-close-button{
    color:var(--accent) !important;
  }
  .leaflet-popup-close-button:hover{
    color:var(--fg) !important;
  }

  /* ポップアップのデザイン */
  .popup{width:min(360px,86vw);font:14px/1.6 system-ui,"Noto Sans JP",sans-serif;color:var(--fg);}
  .popup img{
    width:100%;
    height:auto;
    max-height:30vh;
    border-radius:10px;
    margin-bottom:10px;
    object-fit:contain;
    background:var(--panel2);
    border:1px solid var(--accentBorder);
  }
  .popup .meta{font-size:12px;color:var(--accent);margin-bottom:6px;font-weight:800;letter-spacing:.03em;}
  .popup .desc{font-size:13px;margin-bottom:10px;color:rgba(232,224,201,.92);}
  
  /* プレイヤー部分 */
  .player-box {background:var(--panel2); padding:10px; border-radius:10px; border:1px solid rgba(255,216,107,.22);}
  .player-box audio {width:100%; margin-bottom:10px;}
  .track-list {max-height:160px; overflow-y:auto; border-top:1px solid rgba(255,216,107,.18);}
  .track-btn {
    display:block;
    width:100%;
    text-align:left;
    padding:8px 8px;
    border:none;
    border-bottom:1px solid rgba(255,216,107,.15);
    background:transparent;
    cursor:pointer;
    font-size:13px;
    color:var(--fg);
  }
  .track-btn:hover {background:rgba(255,216,107,.12);}
  .track-btn.playing {background:var(--accent); color:#000; font-weight:900;}

  @media (max-width: 480px){
    .popup{width:92vw;}
    .popup img{max-height:26vh;}
    .track-list{max-height:22vh;}
  }

  /* 写真ピン（丸サムネ） */
  .photo-marker{
    width:34px;
    height:34px;
    border-radius:999px;
    background-size:cover;
    background-position:center;
    border:2px solid var(--accent);
    box-shadow:0 10px 22px rgba(0,0,0,.55);
  }
  .photo-marker--fallback{
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    color:#000;
    background:var(--accent);
  }
  .leaflet-marker-icon.photo-div-icon{background:transparent;border:none;}

  /* カスタムプレイヤー */
  .player{
    background:var(--panel2);
    border:1px solid rgba(255,216,107,.22);
    border-radius:12px;
    padding:10px;
  }
  .player .row{display:flex;align-items:center;gap:10px;}
  .player .btn{
    width:38px;height:38px;border-radius:999px;
    border:1px solid rgba(255,216,107,.35);
    background:rgba(0,0,0,.35);
    color:var(--fg);
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;
  }
  .player .btn:hover{background:rgba(255,216,107,.12);}
  .player .time{font-size:12px;color:rgba(232,224,201,.9);min-width:82px;text-align:right;}
  .player .seek{flex:1;}
  .player input[type="range"]{width:100%;}
  .player .track-list{margin-top:10px;max-height:160px;overflow-y:auto;border-top:1px solid rgba(255,216,107,.18);}
  .player .track{
    display:flex;align-items:center;gap:8px;
    width:100%;
    padding:9px 8px;
    border:none;
    border-bottom:1px solid rgba(255,216,107,.15);
    background:transparent;
    cursor:pointer;
    font-size:13px;
    color:var(--fg);
    text-align:left;
  }
  .player .track:hover{background:rgba(255,216,107,.12);}
  .player .track.playing{background:var(--accent);color:#000;font-weight:900;}
  .player .track .ico{width:16px;opacity:.95;}
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(async () => {
  // ■ 設定：画像とデータ
  const IMG_URL  = './tsuchiura_map.jpg'; // 地図画像
  const DATA_URL = './spots.json';        // データファイル
  
  // URL補正用
  const BASE = new URL('.', location.href).href;
  const abs = rel => new URL(rel, BASE).href;

  const formatTime = (sec) => {
    if (!Number.isFinite(sec) || sec < 0) return '0:00';
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${String(s).padStart(2,'0')}`;
  };

  let currentAudio = null;
  const stopCurrent = () => {
    if (!currentAudio) return;
    try { currentAudio.pause(); } catch {}
    currentAudio = null;
  };

  // 画像サイズ取得とマップ初期化
  const img = await new Promise((res, rej)=>{
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = IMG_URL;
  });
  const W = img.naturalWidth, H = img.naturalHeight;

  // 座標系設定（左上原点、Y軸反転対応）
  const bounds = [[0,0],[H,W]];
  const imageBounds = L.latLngBounds(bounds);
  const map = L.map('map',{ crs:L.CRS.Simple, minZoom:-4, maxZoom:4, zoomControl:true });
  L.imageOverlay(IMG_URL, bounds).addTo(map);
  map.fitBounds(imageBounds, { padding:[0,0] });
  // ポップアップが画面外に見切れないよう、少しだけ外側へパンできる余白を持たせる
  map.setMaxBounds(imageBounds.pad(0.35));

  const toLatLng = (x,y) => map.unproject([x, H - y], 0);
  const toPixel  = (ll)  => {
    const p = map.project(ll, 0);
    return { x: Math.round(p.x), y: Math.round(H - p.y) };
  };

  // spots.json 読み込み
  let spots = [];
  try {
    const res = await fetch(DATA_URL, { cache:'no-store' });
    spots = await res.json();
  } catch(e) {
    console.warn('JSON読込エラー（初回は無視してください）', e);
  }

  // ▼ ピンを地図に刺す処理（写真サムネの丸ピン）
  const makePhotoIcon = (spot) => {
    const size = 34;
    const hasPhoto = Boolean(spot.photo);
    const html = hasPhoto
      ? `<div class="photo-marker" style="background-image:url('${abs(spot.photo)}')"></div>`
      : `<div class="photo-marker photo-marker--fallback">♪</div>`;
    return L.divIcon({
      className: 'photo-div-icon',
      html,
      iconSize: [size, size],
      iconAnchor: [size/2, size/2],
      popupAnchor: [0, -size/2],
    });
  };

  spots.forEach((spot, index) => {
    // プレイリストの生成
    const tracks = spot.playlist || [];
    const firstTrack = tracks[0] ? abs(tracks[0].file) : '';
    
    // HTML組み立て
    const div = document.createElement('div');
    div.className = 'popup';
    div.innerHTML = `
      <div data-photo-slot></div>
      <div class="meta">${spot.title || 'No Title'}</div>
      <div class="desc">${spot.desc || ''}</div>
      <div class="player" id="player-${index}">
        <div class="row">
          <button class="btn" type="button" aria-label="再生/停止" data-play-btn>▶</button>
          <div class="seek"><input type="range" min="0" max="100" value="0" step="0.1" data-seek></div>
          <div class="time" data-time>0:00 / 0:00</div>
        </div>
        <audio id="audio-${index}" preload="metadata" src="${firstTrack}"></audio>
        <div class="track-list" id="list-${index}"></div>
      </div>
    `;

    // トラックボタンを動的に追加
    const listContainer = div.querySelector(`#list-${index}`);
    const audioEl = div.querySelector(`#audio-${index}`);
    const playBtn = div.querySelector('[data-play-btn]');
    const seekEl = div.querySelector('[data-seek]');
    const timeEl = div.querySelector('[data-time]');

    const setPlayingUI = (playing) => {
      playBtn.textContent = playing ? '❚❚' : '▶';
    };
    const updateTimeUI = () => {
      const cur = audioEl.currentTime || 0;
      const dur = Number.isFinite(audioEl.duration) ? audioEl.duration : 0;
      timeEl.textContent = `${formatTime(cur)} / ${formatTime(dur)}`;
      if (dur > 0 && !seekEl.matches(':active')) {
        seekEl.value = String((cur / dur) * 100);
      }
    };

    playBtn.onclick = () => {
      if (!audioEl.src) return;
      if (audioEl.paused) {
        if (currentAudio && currentAudio !== audioEl) stopCurrent();
        currentAudio = audioEl;
        audioEl.play();
      } else {
        audioEl.pause();
      }
    };
    seekEl.addEventListener('input', () => {
      const dur = Number.isFinite(audioEl.duration) ? audioEl.duration : 0;
      if (dur <= 0) return;
      const pct = Number(seekEl.value) / 100;
      audioEl.currentTime = Math.max(0, Math.min(dur, dur * pct));
      updateTimeUI();
    });
    audioEl.addEventListener('loadedmetadata', updateTimeUI);
    audioEl.addEventListener('timeupdate', updateTimeUI);
    audioEl.addEventListener('play', () => setPlayingUI(true));
    audioEl.addEventListener('pause', () => setPlayingUI(false));
    audioEl.addEventListener('ended', () => setPlayingUI(false));

    const setActiveTrackUI = (activeBtn) => {
      div.querySelectorAll('.player .track').forEach(b => b.classList.remove('playing'));
      if (activeBtn) activeBtn.classList.add('playing');
    };

    tracks.forEach((track) => {
      const btn = document.createElement('button');
      btn.className = 'track';
      btn.type = 'button';
      btn.innerHTML = `<span class="ico">▶</span><span>${track.name}</span>`;
      btn.onclick = () => {
        audioEl.src = abs(track.file);
        if (currentAudio && currentAudio !== audioEl) stopCurrent();
        currentAudio = audioEl;
        audioEl.play();
        setActiveTrackUI(btn);
      };
      listContainer.appendChild(btn);
    });

    const marker = L.marker(toLatLng(spot.x, spot.y), {icon: makePhotoIcon(spot)}).addTo(map);

    // 画像は遅延ロードされるため、読み込み完了後にpopupサイズを更新する
    if (spot.photo) {
      const slot = div.querySelector('[data-photo-slot]');
      const imgEl = document.createElement('img');
      imgEl.alt = spot.title || '';
      imgEl.src = abs(spot.photo);
      imgEl.onload = () => {
        const popup = marker.getPopup();
        if (popup) {
          popup.update();
          if (marker.isPopupOpen()) marker.openPopup();
        }
      };
      imgEl.onerror = () => {
        const fallback = document.createElement('div');
        fallback.className = 'desc';
        fallback.textContent = `画像を読み込めませんでした: ${spot.photo}`;
        slot.replaceChildren(fallback);
        const popup = marker.getPopup();
        if (popup) {
          popup.update();
          if (marker.isPopupOpen()) marker.openPopup();
        }
      };
      slot.appendChild(imgEl);
    }

    marker.bindPopup(div, {
      maxWidth: 360,
      keepInView: true,
      autoPanPadding: [16, 24],
    });

    marker.on('popupclose', () => {
      if (currentAudio === audioEl) stopCurrent();
      setPlayingUI(false);
    });
  });

  // ▼ 座標取得（必要ならここで利用）
  // map.on('click', e => console.log(toPixel(e.latlng)));

})();
</script>
</body>
</html>
